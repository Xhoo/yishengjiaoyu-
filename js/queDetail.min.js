$(function() { //"www.baidu.com?id=8&mame=8989";//window.location.href;
	var preUrl = window.location.href;
	var splitUrl = getUrl(preUrl);
//	console.log(splitUrl);
	var id = splitUrl.id;
	var ddd = splitUrl.type;
	//var channel=splitUrl.channel;
	
	$.ajax({
		url: localhost() + "problem/get_details?type=0&id=" + id,
		dataType: "json",
		async: true,
		type: "GET",
		beforeSend: function() {
			console.log("======== 请求之前调用 =========")
		},
		success: function(shuju) {
			if(shuju.code == 1002) {
				window.location.href = locationHref() + 'yishengjiaoyu/login';
			}

			console.log("========= 服务器响应成功调用 ==========");
			console.log(shuju);
			
			if(shuju.data.collection == 0) {
				star=false;
				$("#shoucang img").attr("src", "img/ic_collect_grey.png");
			} else {
				star=true;
				$("#shoucang img").attr("src", "img/ic_collect_yellow.png")
			}

			$(".question>img:nth-of-type(1)").attr("src", shuju.data.userModel.userUrl);
			$("#jifen").html(shuju.data.integral + "积分");
			$("#name").html(shuju.data.userModel.userName);
			var oTime = shuju.data.time;

			function jsDateDiff(publishTime) {
				var d_minutes, d_hours, d_days;
				var timeNow = Date.parse(new Date()) / 1000;
//				console.log(timeNow);
				var d;
				var s = new Date(publishTime * 1000);
				d = timeNow - publishTime;
				d_days = parseInt(d / 86400);
				d_hours = parseInt(d / 3600);
				d_minutes = parseInt(d / 60);
				if(d_days > 0 && d_days < 4) {
					return d_days + "天前"
				} else if(d_days <= 0 && d_hours > 0) {
					return d_hours + "小时前"
				} else if(d_hours <= 0 && d_minutes > 0) {
					return d_minutes + "分钟前"
				} else if(d_minutes <= 0) {
					return "刚刚"
				} else {
					return s.getFullYear() + "年" + (s.getMonth() + 1) + "月" + s.getDate() + "日";
				}
			}
//			console.log(okTime);
			$("span[id='shijian']").html(jsDateDiff(oTime));
			$(".question-second p").html(shuju.data.problemTitle);
			$(".question-second span").html(shuju.data.problemContent);
			var str = shuju.data.problemImage;
			var aaa = str.replace('"', '').replace("[", "").replace("]", "");
			var obj = aaa.split(",");
//			console.log(obj);
			for(var i = 0; i < obj.length-1; i += 1) {
				$("<img src=" + obj[i] + ">").appendTo(".question-img")
			}
			$(".school").html(shuju.data.problemLevel);
			$(".number").html(shuju.data.answerTotal + "个回答");
			for(var value of shuju.data.answerList) {
				time(value.time);
				var okTime = time(Y + M + D + h + m + s);
//				console.log(value.userUrl);
				if(value.acceptionStatus == 1) {
					var acp = "采纳答案"
				} else {
					
					var acp = ""
				}
				if(value.like == 0) {
					var src = "./img/zan.png"
				} else {
					var src = "./img/ic_up_blue.png"
				}
				$("<li id="+value.id+"><aside><img src=" + value.userUrl + "></aside><article><section><span class=''>" + value.userName + "</span><span class=''>" + acp + "</span></section><section><span class=''>" + value.acceptionContent + "</span></section><section><span class="+value.like+"><img src=" + src + "><span>" + value.likeTotal + "</span></span><span class=''>" + okTime + "</span></section></article></li>").appendTo("#oUl")
			}
			if (shuju.data.status!=1) {
				$(".huida").css("display","none")
				$(".question #shoucang").css("display","none")
				$(".question article section:nth-of-type(1) span:nth-of-type(2)").css({
					"border":"solid 1px #07D9CA",
					"color":"#07D9CA",
					"borderRadius":"10%"
				})
				$("#oUl article section:nth-of-type(1) span:nth-of-type(2)").html("采纳答案");
				$("#oUl").on("touchstart","article section:nth-of-type(1) span:nth-of-type(2)",function(){
					var idd=$(this).parents("li").attr("id");
					var $this=$(this);
					$.ajax({
						type:"get",
						url: localhost() + "answer/set_answer?id="+idd,
						async:true,
						success:function(shuju){
							console.log(shuju)
							$("#oUl article section:nth-of-type(1) span:nth-of-type(2)").css("display","none")
							$this.parents("li").insertBefore($("#oUl li:nth-of-type(1)"));
							$this.css({
								"display":"block",
								"border":"none",
								"color":"#FF910F"
							});
							$this.html("已采纳")
							
						}
					});
				})
			} 
//			console.log(shuju.data.id)
			$(".huida").on("touchstart", function() {
				var urls = "yishengjiaoyu/huida.html?id=" + shuju.data.id + "&type=1&acceptionTitle=" + encodeURI(shuju.data.problemTitle) + "&timestamp=" + timestamp;
				getPath(urls);
			})
		},
		error: function() {
			console.log("======= 服务器响应失败调用 ==========")
		},
		complete: function() {
			console.log("======== 请求完毕之后调用，注意：无论服务器响应成功与否，都会调用这个函数！！ ===========")
		}
	});


	$("#shoucang img").on("touchstart", function(shoucang) {
	var shoucang = {
		"type": 4
	}
	shoucang.id=id;
		$.ajax({ //localhost()+"problem/get_search_for_list?type=1&labelSecond=问作业",
			url: localhost() + "interactive/set_collection",
			dataType: "json",
			contentType: "application/json",
			async: true,
			data: JSON.stringify(shoucang),
			type: "POST",
			beforeSend: function() {
				console.log("======== 请求之前调用 =========")
			},
			success: function(shuju) {
				if(shuju.code == 1002) {
					window.location.href = locationHref() + 'yishengjiaoyu/login';
				}
				console.log("========= 服务器响应成功调用 ==========");
				console.log(shuju)
				if(shuju.data == 1) {
					if (star==true) {
						$("#shoucang img").attr("src", "./img/ic_collect_grey.png");
						star=false;
					} else{
						$("#shoucang img").attr("src", "./img/ic_collect_yellow.png")
						star=true;
					}
				} else {
					$("#shoucang img").attr("src", "./img/ic_collect_grey.png");
				}
			},
			error: function() {
				console.log("======= 服务器响应失败调用 ==========")
			},
			complete: function() {
				console.log("======== 请求完毕之后调用，注意：无论服务器响应成功与否，都会调用这个函数！！ ===========")
			}
		})
	})
	console.log()
	
	$("#oUl").on("touchstart","li section:nth-of-type(3) span img",function(){
		var oImg=$(this);
		var zanshuju={"type":4};
		var zan=oImg.parents("span").attr("class");
		zanshuju.id=$(this).parents("li").attr("id")
		console.log(zanshuju)
	
		$.ajax({ //localhost()+"problem/get_search_for_list?type=1&labelSecond=问作业",
			url: localhost() + "interactive/set_collection",
			dataType: "json",
			contentType: "application/json",
			async: true,
			data: JSON.stringify(zanshuju),
			type: "POST",
			beforeSend: function() {
				console.log("======== 请求之前调用 =========")
			},
			success: function(shuju) {
				if(shuju.code == 1002) {
					window.location.href = locationHref() + 'yishengjiaoyu/login';
				}
				console.log("========= 服务器响应成功调用 ==========");
				console.log(shuju)
				if(shuju.data == 1) {
					if(zan == 0) {
					oImg.parents("span").attr('class',1);
					oImg.attr("src","./img/ic_up_blue.png")
//					oImg.parents("span").text()=parseInt(oImg.parents("span").text())+1;
					var aaa=parseInt(oImg.parents("span").text())+1;
					oImg.next("span").html(aaa)
//					oImg.parents("span").text(aaa).insertAfter(oImg);
					} else if (zan==1){
					oImg.parents("span").attr('class',0);
					oImg.attr("src","./img/zan.png")
					var aaa=parseInt(oImg.parents("span").text())-1;
					oImg.next("span").html(aaa)
//					oImg.parents("span").text(aaa).insertAfter(oImg);
					}
				} else {
					$("#shoucang img").attr("src", "./img/ic_collect_grey.png");
				}
			},
			error: function() {
				console.log("======= 服务器响应失败调用 ==========")
			},
			complete: function() {
				console.log("======== 请求完毕之后调用，注意：无论服务器响应成功与否，都会调用这个函数！！ ===========")
			}
		})
	})
	console.log($(".question-img img"))
	$(".question-img").on("touchstart","img",function(){
		$(".imgwall").css("display","block");
		$(".imgwall img").attr("src",$(this).attr('src'));
	})
	$(".imgwall").on("touchstart",function(){
		$(".imgwall").css("display","none");
	})
	$(".header-left").on("touchstart", function() {
		if(ddd == 0) {
			var urls = "yishengjiaoyu/html/qzindex.html";
			getPath(urls);
		} else if(ddd == 1) {
			window.history.go(-1);
		}

	});

})